# OpenTelemetry Collector Configuration
# Dual export to AWS CloudWatch and Braintrust

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 10s
    send_batch_size: 512
    send_batch_max_size: 1024

  resource:
    attributes:
      - key: service.name
        value: ${SERVICE_NAME}
        action: upsert
      - key: service.version
        value: ${SERVICE_VERSION}
        action: upsert
      - key: deployment.environment
        value: ${DEPLOYMENT_ENVIRONMENT}
        action: upsert
      - key: aws.region
        value: ${AWS_REGION}
        action: upsert

  memory_limiter:
    check_interval: 1s
    limit_mib: 512

exporters:
  # AWS CloudWatch Exporter
  awsemf:
    region: ${AWS_REGION}
    namespace: AWS/Bedrock-AgentCore
    log_group_name: /aws/agentcore/traces
    log_stream_name: ${SERVICE_NAME}
    resource_to_telemetry_conversion:
      enabled: true
    dimension_rollup_option: NoDimensionRollup
    # Note: Metrics are collected from the Bedrock AgentCore Runtime.
    # The runtime automatically emits metrics like Invocations, Latency, Errors, etc.
    # These are available in CloudWatch under the bedrock-agentcore namespace.
    # Uncomment metric_declarations below if your application emits custom metrics.

  # Braintrust OTLP Exporter
  otlp/braintrust:
    endpoint: https://api.braintrust.dev/otel
    headers:
      Authorization: Bearer ${BRAINTRUST_API_KEY}
    tls:
      insecure: false
    compression: gzip
    timeout: 30s

  # Logging exporter for debugging
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [awsemf, otlp/braintrust, logging]

    metrics:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [awsemf, otlp/braintrust, logging]

    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [awsemf, otlp/braintrust, logging]

  telemetry:
    logs:
      level: info
    metrics:
      level: detailed
      address: 0.0.0.0:8888

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777
  zpages:
    endpoint: 0.0.0.0:55679
