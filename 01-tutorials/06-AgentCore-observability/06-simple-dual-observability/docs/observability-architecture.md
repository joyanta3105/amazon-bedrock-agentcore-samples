# Observability Architecture

This guide explains how OpenTelemetry (OTEL) observability works in Amazon Bedrock AgentCore Runtime, including log types, trace correlation, and platform architecture.

## Overview

Amazon Bedrock AgentCore Runtime provides automatic OpenTelemetry (OTEL) instrumentation for agents. This means your agent code automatically generates structured logs, traces, and metrics without any code changes.

## Log Types in AgentCore

When you view CloudWatch logs for your agent, you'll see two types of log streams:

### 1. Runtime Logs (`runtime-logs`)

Standard application logs from your agent code using Python's logging framework.

**Format**: Plain text with timestamp and log level
```
2025-10-26T15:34:35.950000+00:00 2025/10/26/[runtime-logs]bfe11fc1...
2025-10-26 15:34:35,950,p1,{time_tool.py:37},ERROR,Unknown timezone: Tokyo
```

**Contents**:
- Your application's `logger.info()`, `logger.error()`, etc. statements
- Standard Python logging output
- Readable by humans
- Uses the logging format you configure in your code

**When to use**:
- Debugging application logic
- Viewing business logic errors
- Understanding code execution flow

### 2. OTEL Runtime Logs (`otel-rt-logs`)

Structured JSON logs automatically generated by OpenTelemetry instrumentation.

**Format**: JSON with rich metadata
```json
{
  "resource": {
    "attributes": {
      "service.name": "weather_time_observability_agent.DEFAULT",
      "cloud.region": "us-east-1",
      "cloud.platform": "aws_bedrock_agentcore",
      "telemetry.sdk.name": "opentelemetry",
      "telemetry.sdk.version": "1.33.1"
    }
  },
  "scope": {
    "name": "tools.time_tool"
  },
  "severityNumber": 17,
  "severityText": "ERROR",
  "body": "Unknown timezone: Tokyo",
  "attributes": {
    "code.file.path": "/app/tools/time_tool.py",
    "code.function.name": "_validate_timezone",
    "code.line.number": 37,
    "otelTraceID": "68fe3f82667cdc015abcd1d779d96d56",
    "otelSpanID": "49dbfa0650a0f03d"
  },
  "traceId": "68fe3f82667cdc015abcd1d779d96d56",
  "spanId": "49dbfa0650a0f03d"
}
```

**Contents**:
- Same log messages as runtime logs but in structured JSON
- Correlation IDs (`traceId`, `spanId`) linking logs to traces
- Rich context about the service, deployment, and cloud environment
- Exact code location (file, function, line number)
- Severity levels in both numeric and text format

**When to use**:
- Correlating logs with distributed traces
- Automated log analysis and alerting
- Cross-service troubleshooting
- Performance analysis with trace correlation

## Key Components of OTEL Logs

### Resource Attributes

Describe the environment and service:

```json
"resource": {
  "attributes": {
    "service.name": "weather_time_observability_agent.DEFAULT",
    "cloud.region": "us-east-1",
    "cloud.provider": "aws",
    "cloud.platform": "aws_bedrock_agentcore",
    "cloud.resource_id": "arn:aws:bedrock-agentcore:...",
    "deployment.environment.name": "bedrock-agentcore:default",
    "telemetry.sdk.name": "opentelemetry",
    "telemetry.sdk.version": "1.33.1",
    "telemetry.auto.version": "0.12.2-aws"
  }
}
```

**Important attributes**:
- `service.name`: Your agent's name
- `cloud.region`: AWS region where agent runs
- `cloud.platform`: Always `aws_bedrock_agentcore`
- `cloud.resource_id`: Full ARN of your agent runtime
- `telemetry.auto.version`: AWS OpenTelemetry auto-instrumentation version

### Scope

Identifies which part of the code generated the log:

```json
"scope": {
  "name": "tools.time_tool"  // Python module name
}
```

### Severity Levels

OTEL uses numeric severity levels aligned with standard log levels:

| Severity Number | Severity Text | Python Level |
|----------------|---------------|--------------|
| 9 | INFO | INFO |
| 13 | WARN | WARNING |
| 17 | ERROR | ERROR |
| 21 | FATAL | CRITICAL |

### Trace Correlation

Links logs to distributed traces:

```json
"attributes": {
  "otelTraceID": "68fe3f82667cdc015abcd1d779d96d56",
  "otelSpanID": "49dbfa0650a0f03d",
  "otelTraceSampled": true
}
```

**Usage**:
- `traceId`: Unique ID for the entire request/invocation
- `spanId`: Unique ID for this specific operation
- Search X-Ray traces by `traceId` to see the complete request flow
- Search logs by `traceId` to see all logs for a request

### Code Location

Exact source location of the log:

```json
"attributes": {
  "code.file.path": "/app/tools/time_tool.py",
  "code.function.name": "_validate_timezone",
  "code.line.number": 37
}
```

## How OTEL Logs Are Generated

### Automatic Instrumentation

AgentCore Runtime automatically instruments your agent code using AWS OpenTelemetry Distro:

1. **Container Startup**: The Dockerfile uses `opentelemetry-instrument` wrapper:
   ```dockerfile
   CMD ["opentelemetry-instrument", "python", "-m", "agent.weather_time_agent"]
   ```

2. **Auto-Instrumentation**: AWS OTEL Distro automatically (when enabled):
   - Wraps Python logging calls
   - Captures log context (file, function, line)
   - Adds trace correlation IDs
   - Enriches with resource attributes
   - Exports to CloudWatch Logs and external platforms (like Braintrust)

3. **Dual Output**: When OTEL is enabled, every log statement generates:
   - Human-readable log in `runtime-logs` stream
   - Structured JSON in `otel-rt-logs` stream

**OTEL Configuration**: OTEL instrumentation can be disabled via the `disable_otel` parameter during deployment. When disabled, only `runtime-logs` are generated. This tutorial keeps OTEL enabled to support dual platform export (CloudWatch + Braintrust).

### No Code Changes Required

Your existing logging code works unchanged:

```python
import logging

logger = logging.getLogger(__name__)

# This simple log statement automatically generates both:
# 1. Plain text runtime log
# 2. Structured OTEL JSON log with trace correlation
logger.error("Unknown timezone: Tokyo")
```

## Log Streams in CloudWatch

AgentCore creates log streams in your CloudWatch log group. The specific streams depend on your OTEL configuration:

### Log Group Structure
```
/aws/bedrock-agentcore/runtimes/{AGENT_ID}-DEFAULT/
├── runtime-logs/         # Plain text application logs (always created)
│   └── {uuid}           # One stream per container instance
└── otel-rt-logs          # Structured OTEL JSON logs (only when OTEL enabled)
```

**Note**: The `otel-rt-logs` stream is only created when OpenTelemetry instrumentation is enabled. This tutorial enables OTEL to support dual platform export.

### Viewing Logs

**Runtime Logs** (human-readable):
```bash
aws logs tail "/aws/bedrock-agentcore/runtimes/{AGENT_ID}-DEFAULT" \
  --since 30m \
  --filter-pattern "ERROR"
```

**OTEL Logs** (structured JSON):
```bash
aws logs tail "/aws/bedrock-agentcore/runtimes/{AGENT_ID}-DEFAULT" \
  --since 30m \
  --filter-pattern "{ $.severityText = \"ERROR\" }"
```

## Correlation Between Logs and Traces

### Trace ID Correlation

Every OTEL log contains `traceId` and `spanId` that link to X-Ray traces:

**Example Workflow**:

1. **Find Error in Logs**:
   ```bash
   scripts/check_logs.sh --errors
   ```

   Output shows `traceId`:
   ```json
   "traceId": "68fe3f82667cdc015abcd1d779d96d56"
   ```

2. **View Trace in X-Ray**:
   - Navigate to CloudWatch X-Ray Console
   - Search by trace ID: `68fe3f82667cdc015abcd1d779d96d56`
   - See complete request flow with timing

3. **Correlate Span**:
   - Each span in the trace has a `spanId`
   - Logs with matching `spanId` occurred during that span
   - See exact timing and context of each log

### Example: Debugging with Correlation

**Scenario**: Agent invocation taking too long

1. **Check logs** for the slow request:
   ```bash
   scripts/check_logs.sh --time 1h
   ```

2. **Extract trace ID** from log:
   ```json
   "traceId": "68fe3f82667cdc015abcd1d779d96d56"
   ```

3. **View trace** in X-Ray to see:
   - Total invocation time: 3.545s
   - Time spent in each tool call
   - Which span caused the delay

4. **Search logs** by span ID to see detailed logs for slow operation:
   ```bash
   aws logs filter-log-events \
     --log-group-name "/aws/bedrock-agentcore/runtimes/{AGENT_ID}-DEFAULT" \
     --filter-pattern "49dbfa0650a0f03d"
   ```

## Querying OTEL Logs

### CloudWatch Logs Insights

Query structured OTEL logs using CloudWatch Logs Insights:

**Error rate by function**:
```sql
fields @timestamp, body, attributes.code.function.name
| filter severityText = "ERROR"
| stats count() by attributes.code.function.name
```

**Average invocation time**:
```sql
fields @timestamp, body
| filter body like /Invocation completed successfully/
| parse body /\((?<duration>\d+\.\d+)s\)/
| stats avg(duration) as avg_duration_seconds
```

**Errors by trace ID**:
```sql
fields @timestamp, body, traceId
| filter severityText = "ERROR"
| sort @timestamp desc
| limit 20
```

## OTEL Export to External Platforms

### Single Platform Export

When OTEL is enabled, AgentCore Runtime exports telemetry to **one platform at a time**:

- **If Braintrust credentials are NOT set**: Telemetry exports to **CloudWatch only**
  - CloudWatch Logs: Structured OTEL logs in `otel-rt-logs` stream
  - CloudWatch Traces: Full distributed traces with all spans and operations
  - CloudWatch GenAI Observability: Agent-level metrics and invocation details

- **If Braintrust credentials ARE set**: Telemetry exports to **Braintrust only**
  - Braintrust receives all OTEL spans and traces via Strands telemetry initialization
  - CloudWatch still receives runtime logs and basic metrics
  - Traces in Braintrust show full low-level details (LLM calls, tool invocations, etc.)

### Observable Differences by Platform

#### CloudWatch (No Braintrust Configured)

**What you see**:
- Agent-level metrics: invocation count, success/failure rates
- Session information: conversation history and context
- Full traces: Complete view of all operations and timing
- Details: See exactly what happens inside each trace (all tool calls, LLM interactions, etc.)

**Best for**: Comprehensive debugging and understanding agent internals

#### Braintrust (With Credentials Configured)

**What you see**:
- Agent-level metrics: Same as CloudWatch (invocation count, etc.)
- Trace visibility: Shows that an invocation happened, but NOT the internal details
- LLM-specific data: Cost tracking, quality scores, custom metrics
- Low-level details: Available in Braintrust, NOT in CloudWatch

**Trade-off**: Less visibility in CloudWatch, more detailed observability in Braintrust platform

**Best for**: External observability platform with LLM-specific insights

#### CloudWatch APM (Agent Services)

**What you see**:
- Built-in agent dashboards for monitoring
- Agent performance metrics across time
- Error rates and trends

**Best for**: Quick operational overview of agent health

See [demo.md](./demo.md) for detailed examples and screenshots of each platform's capabilities.

### How Export Works

```
Agent Code (Python Logging)
    ↓
OpenTelemetry Auto-Instrumentation
    ↓
OTEL SDK (in agent container)
    ↓
    If Braintrust credentials set:
        └─→ OTEL Exporter → Braintrust
    Else:
        └─→ AWS OTEL Distro → CloudWatch Logs + Traces

    (Runtime logs always go to CloudWatch)
```

### Export Configuration

The deployment script automatically configures export based on environment variables:

- **BRAINTRUST_API_KEY** and **BRAINTRUST_PROJECT_ID**: When both are set, exports to Braintrust
- When Braintrust credentials are empty or commented out: Exports to CloudWatch

No manual OTEL configuration needed - the deployment script handles it automatically.

## Benefits of OTEL Logs

### 1. Automatic Trace Correlation

Every log is automatically linked to its distributed trace:
- No manual correlation needed
- Seamless navigation from logs to traces
- Complete request context

### 2. Structured Data

JSON format enables:
- Programmatic log analysis
- Advanced filtering and aggregation
- Machine learning on log data
- Automated alerting

### 3. Vendor Neutrality

OTEL is an open standard:
- Works with any OTEL-compatible platform
- Not locked into AWS
- Same data format across vendors
- Easy to add new export destinations

### 4. Rich Context

Automatic enrichment with:
- Service and deployment information
- Cloud resource details
- Code location (file, function, line)
- Trace correlation IDs
- Severity levels

### 5. Zero Code Changes

- Works with existing Python logging
- No instrumentation code needed
- No library imports required
- Just log normally

## Best Practices

### 1. Use Descriptive Log Messages

OTEL captures your exact log message:

```python
# Good - clear and actionable
logger.error(f"Unknown timezone: {timezone}")

# Bad - vague
logger.error("Validation failed")
```

### 2. Use Appropriate Log Levels

OTEL preserves your log levels:

```python
logger.debug("Starting timezone validation")  # Development only
logger.info("Timezone validated successfully")  # Normal operation
logger.warning("Timezone not in cache, fetching")  # Potential issue
logger.error("Unknown timezone")  # Actual error
```

### 3. Log Structured Data

For complex data, use structured logging:

```python
import json

logger.info(f"Processing request: {json.dumps(request_data, indent=2)}")
```

OTEL captures this in the `body` field, making it searchable.

### 4. Don't Log Sensitive Data

Remember: logs go to CloudWatch and may export to external platforms:

```python
# Bad - logs API key
logger.info(f"API key: {api_key}")

# Good - logs only necessary info
logger.info("API authentication successful")
```

### 5. Use Trace IDs for Debugging

When troubleshooting:

1. Get trace ID from error logs
2. Search X-Ray for complete trace
3. See all operations and timing
4. Correlate with OTEL logs for details

## Comparison: Runtime Logs vs OTEL Logs

| Feature | Runtime Logs | OTEL Logs |
|---------|-------------|-----------|
| Format | Plain text | Structured JSON |
| Human readable | ✓ Yes | ✗ No (needs parsing) |
| Machine parsable | Limited | ✓ Fully structured |
| Trace correlation | ✗ No | ✓ Yes (traceId/spanId) |
| Code location | In message only | ✓ Structured fields |
| Cloud context | ✗ No | ✓ Full resource attributes |
| Export to platforms | CloudWatch only | ✓ Any OTEL platform |
| Search/filter | Text search | ✓ JSON field queries |
| Best for | Quick debugging | Analysis & correlation |

## Common Use Cases

### 1. Debugging Errors

**Find recent errors**:
```bash
scripts/check_logs.sh --errors --time 1h
```

**Get trace ID from error log**, then view in X-Ray.

### 2. Performance Analysis

**Search OTEL logs** for invocation timing:
```sql
fields @timestamp, body
| filter body like /completed successfully/
| parse body /\((?<duration>\d+\.\d+)s\)/
| stats avg(duration), max(duration), min(duration)
```

### 3. Error Rate Monitoring

**CloudWatch alarm** on OTEL error count:
```sql
fields @timestamp
| filter severityNumber >= 17
| stats count() as error_count
```

### 4. Distributed Tracing

**Find all logs** for a specific request:
```bash
aws logs filter-log-events \
  --log-group-name "/aws/bedrock-agentcore/runtimes/{AGENT_ID}-DEFAULT" \
  --filter-pattern "{TRACE_ID}"
```

### 5. Tool Usage Analysis

**Track which tools are called**:
```sql
fields @timestamp, scope.name, body
| filter scope.name like /tools\./
| stats count() by scope.name
```

## Troubleshooting

### No OTEL Logs Appearing

**Check**:
1. OpenTelemetry instrumentation is enabled in Dockerfile:
   ```dockerfile
   CMD ["opentelemetry-instrument", "python", "-m", "agent.weather_time_agent"]
   ```

2. Log group exists:
   ```bash
   aws logs describe-log-groups \
     --log-group-name-prefix "/aws/bedrock-agentcore/runtimes/"
   ```

3. Agent is generating logs (check runtime-logs first)

### OTEL Logs Missing Trace IDs

**Cause**: Request not sampled or outside trace context

**Fix**: Ensure logs are within agent invocation handler

### Cannot Parse OTEL JSON

**Cause**: Logs Insights treats newlines as separators

**Fix**: Use `parse` to extract JSON fields or enable JSON parsing

## Additional Resources

- [OpenTelemetry Specification](https://opentelemetry.io/docs/specs/otel/)
- [AWS Distro for OpenTelemetry](https://aws-otel.github.io/)
- [CloudWatch Logs Insights Query Syntax](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)
- [X-Ray Trace Analysis](https://docs.aws.amazon.com/xray/latest/devguide/xray-console-analytics.html)
